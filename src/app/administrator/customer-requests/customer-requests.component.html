<!-- customer-requests.component.html -->
<div class="main-content">
    <div class="container-fluid">

        <!-- Page Header -->
        <div class="row">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header card-header-icon card-header-primary">
                        <div class="card-icon">
                            <i class="material-icons">local_shipping</i>
                        </div>
                        <h4 class="card-title">Yetkazish So'rovi</h4>
                        <p class="card-category">Qutillaringizni yetkazish uchun so'rov yuboring</p>
                    </div>
                    <div class="card-body">

                        <!-- Simple Action Buttons -->
                        <div class="action-buttons">
                            <button class="btn btn-primary" (click)="showPackageSelectionStep()"
                                [disabled]="loadingPackages">
                                <i class="material-icons">add</i>
                                Yangi So'rov
                            </button>

                            <button class="btn btn-info" (click)="showMyRequestsList()">
                                <i class="material-icons">list</i>
                                Mening So'rovlarim
                            </button>

                            <button class="btn btn-success" (click)="loadCustomerPackages()"
                                [disabled]="loadingPackages">
                                <i class="material-icons">refresh</i>
                                Yangilash
                            </button>
                        </div>

                    </div>
                </div>
            </div>
        </div>

        <!-- Package Selection Step -->
        <div class="row" *ngIf="showPackageSelection">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header card-header-warning">
                        <h4 class="card-title">
                            <span class="step-badge">1</span>
                            Qutillarni Tanlang
                        </h4>
                    </div>
                    <div class="card-body">

                        <!-- Loading -->
                        <div *ngIf="loadingPackages" class="text-center p-5">
                            <div class="spinner-border text-warning" style="width: 3rem; height: 3rem;"></div>
                            <p class="mt-3">Yuklanmoqda...</p>
                        </div>

                        <!-- Simple Package Cards -->
                        <div *ngIf="!loadingPackages && customerPackages.length > 0">
                            <div class="packages-grid">
                                <div class="package-card" *ngFor="let group of customerPackages; let i = index"
                                    [class.selected]="group.selected" (click)="selectPackageGroup(i)">

                                    <div class="check-icon" *ngIf="group.selected">
                                        <i class="material-icons">check_circle</i>
                                    </div>

                                    <div class="package-icon">
                                        <i class="material-icons">inventory_2</i>
                                    </div>

                                    <div class="package-details">
                                        <strong>{{group.total_packages}} ta quti</strong>
                                        <small>{{group.total_items}} mahsulot</small>
                                    </div>

                                    <div class="package-label">
                                        <span *ngIf="group.type === 'tied'" class="badge badge-info">Bog'langan</span>
                                        <span *ngIf="group.type === 'single'"
                                            class="badge badge-secondary">Yagona</span>
                                    </div>

                                    <small class="package-consignment">{{group.consignments[0]}}</small>
                                </div>
                            </div>

                            <!-- Simple Summary -->
                            <div class="selection-summary" *ngIf="selectedPackages.length > 0">
                                <div class="summary-text">
                                    <i class="material-icons">check_circle</i>
                                    <strong>{{selectedPackages.length}} ta quti tanlandi</strong>
                                </div>
                                <button class="btn btn-success btn-lg" (click)="showCreateRequestForm()">
                                    Davom etish
                                    <i class="material-icons">arrow_forward</i>
                                </button>
                            </div>
                        </div>

                        <!-- Empty State -->
                        <div *ngIf="!loadingPackages && customerPackages.length === 0" class="empty-state">
                            <i class="material-icons">inbox</i>
                            <p>Yetkazish uchun quti mavjud emas</p>
                        </div>

                    </div>
                </div>
            </div>
        </div>

        <!-- Create Request Form -->
        <div class="row" *ngIf="showCreateForm">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header card-header-success">
                        <h4 class="card-title">
                            <span class="step-badge">2</span>
                            Yetkazish Ma'lumotlari
                        </h4>
                    </div>
                    <div class="card-body">

                        <form #deliveryForm="ngForm" (ngSubmit)="submitDeliveryRequest()">

                            <!-- Simple Delivery Type Cards -->
                            <div class="form-section">
                                <label class="section-label">Yetkazish Turi</label>
                                <div class="delivery-grid">
                                    <div class="delivery-option" [class.active]="deliveryType === 'Pick-up'"
                                        (click)="deliveryType = 'Pick-up'; onDeliveryTypeChange()">
                                        <i class="material-icons">store</i>
                                        <span>O'zim olaman</span>
                                    </div>

                                    <div class="delivery-option" [class.active]="deliveryType === 'Yandex'"
                                        (click)="deliveryType = 'Yandex'; onDeliveryTypeChange()">
                                        <i class="material-icons">local_taxi</i>
                                        <span>Yandex</span>
                                    </div>

                                    <div class="delivery-option" [class.active]="deliveryType === 'Own-Courier'"
                                        (click)="deliveryType = 'Own-Courier'; onDeliveryTypeChange()">
                                        <i class="material-icons">delivery_dining</i>
                                        <span>Kuryer</span>
                                    </div>

                                    <div class="delivery-option" [class.active]="deliveryType === 'EMU'"
                                        (click)="deliveryType = 'EMU'; onDeliveryTypeChange()">
                                        <i class="material-icons">business</i>
                                        <span>EMU Post</span>
                                    </div>
                                </div>
                            </div>

                            <!-- Phone -->
                            <div class="form-section">
                                <label class="section-label">Telefon Raqam *</label>
                                <input type="tel" class="form-control" [(ngModel)]="customerPhone" name="customerPhone"
                                    placeholder="+998 90 123 45 67">
                            </div>

                            <!-- EMU Branch -->
                            <div class="form-section" *ngIf="deliveryType === 'EMU'">
                                <label class="section-label">Viloyat *</label>
                                <select class="form-control" [(ngModel)]="selectedRegionId" name="selectedRegionId"
                                    (change)="onRegionSelect(selectedRegionId)">
                                    <option value="">Tanlang</option>
                                    <option *ngFor="let region of regions" [value]="region.id">
                                        {{region.name}}
                                    </option>
                                </select>

                                <label class="section-label mt-3">Filial *</label>
                                <select class="form-control" [(ngModel)]="selectedBranchId" name="selectedBranchId"
                                    [disabled]="!selectedRegionId">
                                    <option value="">Tanlang</option>
                                    <option *ngFor="let branch of branches" [value]="branch.id">
                                        {{branch.name}}
                                    </option>
                                </select>
                            </div>

                            <!-- Address -->
                            <div class="form-section"
                                *ngIf="deliveryType === 'Yandex' || deliveryType === 'Own-Courier'">
                                <label class="section-label">Manzil *</label>
                                <textarea class="form-control" [(ngModel)]="deliveryAddress" name="deliveryAddress"
                                    rows="3" placeholder="To'liq manzilni kiriting"></textarea>
                            </div>

                            <!-- Payment -->
                            <div class="form-section">
                                <label class="section-label">To'lov Summa</label>
                                <input type="number" class="form-control" [(ngModel)]="paymentAmount"
                                    name="paymentAmount" placeholder="0 so'm">

                                <label class="section-label mt-3">To'lov Rasmlari</label>
                                <div class="upload-box">
                                    <input type="file" id="paymentImages" #fileInput
                                        (change)="onPaymentImagesSelected($event)" multiple accept="image/*" hidden>
                                    <label for="paymentImages" class="upload-label">
                                        <i class="material-icons">add_photo_alternate</i>
                                        <span>Rasm yuklash (max 5 ta)</span>
                                    </label>
                                </div>

                                <!-- Image Previews -->
                                <div class="image-previews" *ngIf="selectedPaymentImages.length > 0">
                                    <div class="image-item" *ngFor="let image of selectedPaymentImages; let i = index">
                                        <img [src]="image.preview" [alt]="image.name">
                                        <button type="button" class="remove-btn" (click)="removePaymentImage(i)">
                                            <i class="material-icons">close</i>
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <!-- Notes and Urgent -->
                            <div class="form-section">
                                <label class="section-label">Izoh</label>
                                <textarea class="form-control" [(ngModel)]="deliveryNotes" name="deliveryNotes" rows="2"
                                    placeholder="Qo'shimcha ma'lumot"></textarea>

                                <div class="urgent-check mt-3">
                                    <label>
                                        <input type="checkbox" [(ngModel)]="isUrgent" name="isUrgent">
                                        <span>
                                            <i class="material-icons">priority_high</i>
                                            Shoshilinch yetkazish
                                        </span>
                                    </label>
                                </div>
                            </div>

                            <!-- Buttons -->
                            <div class="form-buttons">
                                <button type="button" class="btn btn-secondary" (click)="goBack()">
                                    <i class="material-icons">arrow_back</i>
                                    Orqaga
                                </button>

                                <button type="submit" class="btn btn-success btn-lg" [disabled]="submittingRequest">
                                    <span *ngIf="!submittingRequest">
                                        <i class="material-icons">send</i>
                                        So'rov Yuborish
                                    </span>
                                    <span *ngIf="submittingRequest">
                                        <span class="spinner-border spinner-border-sm"></span>
                                        Yuborilmoqda...
                                    </span>
                                </button>
                            </div>

                        </form>

                    </div>
                </div>
            </div>
        </div>

        <!-- My Requests - Simplified -->
        <div class="row" *ngIf="showMyRequests">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header card-header-info">
                        <h4 class="card-title">Mening So'rovlarim</h4>
                    </div>
                    <div class="card-body">

                        <div *ngIf="myDeliveryRequests.length > 0" class="requests-container">
                            <div class="request-item" *ngFor="let request of myDeliveryRequests; let i = index">

                                <div class="request-top">
                                    <span class="request-num">#{{i + 1}}</span>
                                    <span class="status-pill" [class.status-pending]="request.status === 'pending'"
                                        [class.status-approved]="request.status === 'approved'"
                                        [class.status-rejected]="request.status === 'rejected'">
                                        {{getStatusText(request.status)}}
                                    </span>
                                </div>

                                <div class="request-content">
                                    <div class="request-row">
                                        <i class="material-icons">local_shipping</i>
                                        <span>{{getDeliveryTypeText(request.delivery_type)}}</span>
                                    </div>
                                    <div class="request-row">
                                        <i class="material-icons">inventory_2</i>
                                        <span>{{request.total_packages}} ta quti</span>
                                    </div>
                                    <div class="request-row">
                                        <i class="material-icons">phone</i>
                                        <span>{{request.customer_phone}}</span>
                                    </div>
                                    <div class="request-row">
                                        <i class="material-icons">schedule</i>
                                        <span>{{request.created_at | date:'dd.MM.yyyy HH:mm'}}</span>
                                    </div>
                                </div>

                                <div class="request-note" *ngIf="request.admin_notes || request.rejection_reason">
                                    <small>
                                        {{request.status === 'approved' ? request.admin_notes :
                                        request.rejection_reason}}
                                    </small>
                                </div>
                                <!-- Better styled cancel button -->
                                <button *ngIf="request.status === 'pending'" class="cancel-button"
                                    (click)="cancelRequest(request.id)">
                                    <i class="material-icons">cancel</i>
                                    <span>Bekor qilish</span>
                                </button>

                            </div>
                        </div>

                        <div *ngIf="myDeliveryRequests.length === 0" class="empty-state">
                            <i class="material-icons">assignment</i>
                            <p>So'rovlar mavjud emas</p>
                            <button class="btn btn-primary mt-3" (click)="showPackageSelectionStep()">
                                Birinchi So'rov Yaratish
                            </button>
                        </div>

                    </div>
                </div>
            </div>
        </div>

    </div>
</div>

<!-- Sending Animation Overlay -->
<div class="sending-overlay" *ngIf="showSendingAnimation">
    <div class="sending-animation">
        <div class="message-icon">
            <i class="material-icons">mail_outline</i>
        </div>
        <div class="sending-text">So'rov yuborilmoqda...</div>
        <div class="progress-dots">
            <span></span>
            <span></span>
            <span></span>
        </div>
    </div>
</div>