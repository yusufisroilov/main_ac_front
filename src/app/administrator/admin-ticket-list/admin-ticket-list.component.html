<div class="main-content">
    <div class="container-fluid">
        <!-- Page Header -->
        <div class="row">
            <div class="col-md-12">
                <div class="card" id="listcard">
                    <div class="card-header card-header-primary">
                        <h4 class="card-title">Ticket Management</h4>
                        <p class="card-category">Manage and respond to customer support tickets</p>
                    </div>
                    <div class="card-body">

                        <!-- Stats Row -->
                        <div class="row mb-4">
                            <div class="col-lg-3 col-md-6 col-sm-6">
                                <div class="card card-stats">
                                    <div class="card-header card-header-warning card-header-icon">
                                        <div class="card-icon">
                                            <i class="material-icons">notifications_active</i>
                                        </div>
                                        <p class="card-category">Needs Attention</p>
                                        <h3 class="card-title">{{ notificationCount }}</h3>
                                    </div>
                                </div>
                            </div>
                            <div class="col-lg-3 col-md-6 col-sm-6">
                                <div class="card card-stats">
                                    <div class="card-header card-header-info card-header-icon">
                                        <div class="card-icon">
                                            <i class="material-icons">assignment</i>
                                        </div>
                                        <p class="card-category">Total Tickets</p>
                                        <h3 class="card-title">{{ totalTickets }}</h3>
                                    </div>
                                </div>
                            </div>
                            <div class="col-lg-3 col-md-6 col-sm-6">
                                <div class="card card-stats">
                                    <div class="card-header card-header-success card-header-icon">
                                        <div class="card-icon">
                                            <i class="material-icons">check_circle</i>
                                        </div>
                                        <p class="card-category">Resolved Today</p>
                                        <h3 class="card-title">-</h3>
                                    </div>
                                </div>
                            </div>
                            <div class="col-lg-3 col-md-6 col-sm-6">
                                <div class="card card-stats">
                                    <div class="card-header card-header-danger card-header-icon">
                                        <div class="card-icon">
                                            <i class="material-icons">warning</i>
                                        </div>
                                        <p class="card-category">Urgent</p>
                                        <h3 class="card-title">-</h3>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Filters Row - Simplified like allreceivers -->
                        <div class="toolbar">
                            <div class="row">
                                <!-- Search Input -->
                                <div class="col-sm-6 col-lg-3">
                                    <mat-form-field class="example-full-width">
                                        <input matInput type="text" placeholder="Search by ticket # or subject"
                                            [(ngModel)]="searchQuery" (keyup.enter)="onSearch()" />
                                    </mat-form-field>
                                </div>

                                <!-- Status Dropdown -->
                                <div class="col-sm-6 col-lg-2">
                                    <div class="dropdown">
                                        <button mat-raised-button
                                            class="dropdown-toggle btn btn-primary btn-round btn-block"
                                            data-toggle="dropdown">
                                            {{ selectedStatus === 'all' ? 'All Status' : getStatusLabel(selectedStatus)
                                            }}
                                            <b class="caret"></b>
                                        </button>
                                        <ul class="dropdown-menu dropdown-menu-left">
                                            <li *ngFor="let option of statusOptions">
                                                <a (click)="selectedStatus = option.value; onFilterChange()">{{
                                                    option.label }}</a>
                                            </li>
                                        </ul>
                                    </div>
                                </div>

                                <!-- Priority Dropdown -->
                                <div class="col-sm-6 col-lg-2">
                                    <div class="dropdown">
                                        <button mat-raised-button
                                            class="dropdown-toggle btn btn-primary btn-round btn-block"
                                            data-toggle="dropdown">
                                            {{ selectedPriority === 'all' ? 'All Priority' : selectedPriority }}
                                            <b class="caret"></b>
                                        </button>
                                        <ul class="dropdown-menu dropdown-menu-left">
                                            <li *ngFor="let option of priorityOptions">
                                                <a (click)="selectedPriority = option.value; onFilterChange()">{{
                                                    option.label }}</a>
                                            </li>
                                        </ul>
                                    </div>
                                </div>

                                <!-- Category Dropdown -->
                                <div class="col-sm-6 col-lg-2">
                                    <div class="dropdown">
                                        <button mat-raised-button
                                            class="dropdown-toggle btn btn-primary btn-round btn-block"
                                            data-toggle="dropdown">
                                            {{ selectedCategory === 'all' ? 'All Categories' : selectedCategory }}
                                            <b class="caret"></b>
                                        </button>
                                        <ul class="dropdown-menu dropdown-menu-left">
                                            <li *ngFor="let option of categoryOptions">
                                                <a (click)="selectedCategory = option.value; onFilterChange()">{{
                                                    option.label }}</a>
                                            </li>
                                        </ul>
                                    </div>
                                </div>

                                <!-- Assigned To Dropdown -->
                                <div class="col-sm-6 col-lg-2">
                                    <div class="dropdown">
                                        <button mat-raised-button
                                            class="dropdown-toggle btn btn-primary btn-round btn-block"
                                            data-toggle="dropdown">
                                            {{ selectedAssignedTo === 'all' ? 'All Staff' : selectedAssignedTo }}
                                            <b class="caret"></b>
                                        </button>
                                        <ul class="dropdown-menu dropdown-menu-left">
                                            <li *ngFor="let option of assignedToOptions">
                                                <a (click)="selectedAssignedTo = option.value; onFilterChange()">{{
                                                    option.label }}</a>
                                            </li>
                                        </ul>
                                    </div>
                                </div>

                                <!-- Reset Button -->
                                <div class="col-sm-6 col-lg-1">
                                    <button mat-raised-button class="btn btn-danger btn-block" (click)="resetFilters()">
                                        <i class="material-icons">clear</i>
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Action Buttons -->
                        <div class="row mb-3 mt-3">
                            <div class="col-md-12 text-right">
                                <button mat-raised-button class="btn btn-info" (click)="getListOfTickets()">
                                    <i class="material-icons">refresh</i> Refresh
                                </button>
                                <button mat-raised-button class="btn btn-success ml-2" (click)="exportToExcel()">
                                    <i class="material-icons">file_download</i> Export
                                </button>
                            </div>
                        </div>

                        <!-- Loading Spinner -->
                        <div *ngIf="isLoading" class="text-center py-5">
                            <mat-spinner></mat-spinner>
                        </div>

                        <!-- Tickets Table -->
                        <div class="material-datatables">
                            <div class="table-responsive" *ngIf="!isLoading">
                                <table class="table table-striped table-no-bordered table-hover" cellspacing="0"
                                    width="100%" style="width: 100%">
                                    <thead>
                                        <tr>
                                            <th class="text-center">Ticket #</th>
                                            <th class="text-center">Subject</th>
                                            <th class="text-center">Customer</th>
                                            <th class="text-center">Category</th>
                                            <th class="text-center">Status</th>
                                            <th class="text-center">Priority</th>
                                            <th class="text-center">Assigned To</th>
                                            <th class="text-center">Messages</th>
                                            <th class="text-center">Last Update</th>
                                            <th class="text-center">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr *ngFor="let ticket of filteredTickets; let i = index"
                                            class="text-center cursor-pointer" [ngClass]="{
                        'table-warning': ticket.unread_messages_count > 0,
                        'table-danger': ticket.status === 'unread'
                      }" (click)="viewTicket(ticket)">
                                            <td>
                                                <strong class="text-primary">{{ ticket.ticket_number }}</strong>
                                            </td>
                                            <td class="text-left">{{ ticket.subject }}</td>
                                            <td>{{ ticket.customer_name }}</td>
                                            <td>
                                                <span class="badge badge-secondary">{{ ticket.category }}</span>
                                            </td>
                                            <td>
                                                <span class="badge" [ngClass]="getStatusClass(ticket.status)">
                                                    {{ getStatusLabel(ticket.status) }}
                                                </span>
                                                <span *ngIf="ticket.unread_messages_count > 0"
                                                    class="badge badge-pill badge-danger ml-1">
                                                    {{ ticket.unread_messages_count }}
                                                </span>
                                            </td>
                                            <td>
                                                <span class="badge" [ngClass]="getPriorityClass(ticket.priority)">
                                                    {{ ticket.priority }}
                                                </span>
                                            </td>
                                            <td>
                                                <small>{{ ticket.assigned_to }}</small>
                                            </td>
                                            <td>
                                                <i class="material-icons"
                                                    style="font-size: 18px; vertical-align: middle;">chat</i>
                                                {{ ticket.messages_count }}
                                            </td>
                                            <td>
                                                <small>{{ getTimeAgo(ticket.updated_at) }}</small>
                                            </td>
                                            <td class="td-actions text-right">
                                                <button mat-icon-button [matMenuTriggerFor]="ticketMenu"
                                                    matTooltip="Actions" (click)="$event.stopPropagation()">
                                                    <mat-icon>more_vert</mat-icon>
                                                </button>
                                                <mat-menu #ticketMenu="matMenu">
                                                    <button mat-menu-item (click)="viewTicket(ticket)">
                                                        <mat-icon>visibility</mat-icon>
                                                        <span>View Details</span>
                                                    </button>
                                                    <button mat-menu-item [matMenuTriggerFor]="statusMenu">
                                                        <mat-icon>edit</mat-icon>
                                                        <span>Change Status</span>
                                                    </button>
                                                    <button mat-menu-item [matMenuTriggerFor]="priorityMenu">
                                                        <mat-icon>flag</mat-icon>
                                                        <span>Change Priority</span>
                                                    </button>
                                                    <button mat-menu-item (click)="reassignTicket(ticket)">
                                                        <mat-icon>person</mat-icon>
                                                        <span>Reassign</span>
                                                    </button>
                                                </mat-menu>

                                                <!-- Status submenu -->
                                                <mat-menu #statusMenu="matMenu">
                                                    <button mat-menu-item
                                                        (click)="quickUpdateStatus(ticket, 'open')">Open</button>
                                                    <button mat-menu-item
                                                        (click)="quickUpdateStatus(ticket, 'answered')">Answered</button>
                                                    <button mat-menu-item
                                                        (click)="quickUpdateStatus(ticket, 'closed')">Closed</button>
                                                </mat-menu>

                                                <!-- Priority submenu -->
                                                <mat-menu #priorityMenu="matMenu">
                                                    <button mat-menu-item
                                                        (click)="quickUpdatePriority(ticket, 'Urgent')">Urgent</button>
                                                    <button mat-menu-item
                                                        (click)="quickUpdatePriority(ticket, 'High')">High</button>
                                                    <button mat-menu-item
                                                        (click)="quickUpdatePriority(ticket, 'Medium')">Medium</button>
                                                    <button mat-menu-item
                                                        (click)="quickUpdatePriority(ticket, 'Low')">Low</button>
                                                </mat-menu>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>

                            <!-- No Results -->
                            <div *ngIf="!isLoading && filteredTickets.length === 0" class="text-center py-5">
                                <mat-icon
                                    style="font-size: 64px; width: 64px; height: 64px; color: #999;">inbox</mat-icon>
                                <h3 class="mt-3">No tickets found</h3>
                                <p class="text-muted">Try adjusting your filters or search query</p>
                            </div>

                            <!-- Reusable Pagination Component -->
                            <app-pagination *ngIf="needPagination && !isLoading" [currentPage]="currentPage"
                                [totalPages]="totalPages" (pageChanged)="onPageChanged($event)"></app-pagination>

                            <!-- Pagination Info -->
                            <p *ngIf="!isLoading && totalTickets > 0" class="text-center text-muted mt-3">
                                Showing {{ (currentPage - 1) * pageSize + 1 }}
                                to {{ Math.min(currentPage * pageSize, totalTickets) }}
                                of {{ totalTickets }} tickets
                            </p>
                        </div>

                    </div>
                </div>
            </div>
        </div>
    </div>
</div>