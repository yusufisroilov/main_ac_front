<div class="main-content">
  <div class="container-fluid">
    <div class="row">
      <div class="col-md-12">
        <div class="card" id="listcard">

          <!-- Card Header with Tabs -->
          <div class="card-header card-header-icon"
            style="display: flex; align-items: center; gap: 10px; flex-wrap: wrap; padding: 15px 20px;"
            [ngClass]="activeTab === 'v2' ? 'card-header-primary' : 'card-header-blue'">

            <div style="display: flex; align-items: center; gap: 15px; flex: 1; min-width: 200px;">
              <div class="card-icon"
                style="margin: 0; width: 50px; height: 50px; display: flex; align-items: center; justify-content: center;">
                <i class="material-icons" style="font-size: 28px;">receipt_long</i>
              </div>
              <div>
                <h4 class="card-title" style="margin: 0; font-size: 18px;">
                  {{activeTab === 'v2' ? 'Ledger V2' : 'Eski Tranzaksiyalar'}}
                </h4>
                <p class="card-category" style="margin: 0; font-size: 13px;" *ngIf="activeTab === 'v2'">
                  <strong>{{v2TotalItems}}</strong> ta yozuv
                </p>
              </div>
            </div>

            <!-- Tab Buttons -->
            <div style="display: flex; gap: 4px;">
              <button class="tab-btn" [class.tab-btn-active]="activeTab === 'v2'" (click)="switchTab('v2')">
                Ledger V2
              </button>
              <button class="tab-btn" [class.tab-btn-active]="activeTab === 'v1'" (click)="switchTab('v1')">
                Eski (V1)
              </button>
            </div>
          </div>

          <div class="card-body" style="padding: 20px;">

            <!-- ═══════════════════════════════════════════ -->
            <!-- V2 LEDGER TAB -->
            <!-- ═══════════════════════════════════════════ -->
            <div *ngIf="activeTab === 'v2'">

              <!-- V2 Filters -->
              <div class="v2-filters">
                <div class="filter-item">
                  <input type="text" class="form-control form-control-sm" [(ngModel)]="v2FilterCustomerId"
                    (keyup.enter)="applyV2Filters()" placeholder="Mijoz ID...">
                </div>
                <div class="filter-item">
                  <input type="text" class="form-control form-control-sm" [(ngModel)]="v2FilterConsignment"
                    (keyup.enter)="applyV2Filters()" placeholder="Partiya...">
                </div>
                <div class="filter-item">
                  <select class="form-control form-control-sm" [(ngModel)]="v2FilterType"
                    (change)="applyV2Filters()">
                    <option value="">Barcha turlar</option>
                    <option value="CHARGE">Hisob (CHARGE)</option>
                    <option value="PAYMENT">To'lov (PAYMENT)</option>
                    <option value="BONUS">Bonus</option>
                    <option value="ADJUSTMENT">Tuzatish</option>
                  </select>
                </div>
                <div class="filter-item">
                  <input type="date" class="form-control form-control-sm" [(ngModel)]="v2FilterStartDate"
                    (change)="applyV2Filters()" title="Dan">
                </div>
                <div class="filter-item">
                  <input type="date" class="form-control form-control-sm" [(ngModel)]="v2FilterEndDate"
                    (change)="applyV2Filters()" title="Gacha">
                </div>
                <button class="btn btn-sm btn-warning" (click)="clearV2Filters()"
                  style="display: flex; align-items: center; gap: 4px; padding: 6px 12px;">
                  <i class="material-icons" style="font-size: 16px;">clear</i> Tozalash
                </button>
                <button class="btn btn-sm btn-info" (click)="loadV2Ledger()" [disabled]="v2Loading"
                  style="display: flex; align-items: center; gap: 4px; padding: 6px 12px;">
                  <i class="material-icons" style="font-size: 16px;" [class.rotate]="v2Loading">refresh</i>
                </button>
              </div>

              <!-- V2 Loading -->
              <div *ngIf="v2Loading" class="text-center" style="padding: 40px 20px;">
                <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;"></div>
                <p class="mt-3 text-muted">Ma'lumotlar yuklanmoqda...</p>
              </div>

              <!-- V2 Table -->
              <div *ngIf="!v2Loading && v2Entries.length > 0" class="table-responsive">
                <table class="table table-hover table-striped" cellspacing="0" width="100%">
                  <thead>
                    <tr>
                      <th class="text-center" style="width: 40px;">#</th>
                      <th class="text-center" style="width: 90px;">Turi</th>
                      <th>Mijoz</th>
                      <th>Partiya</th>
                      <th class="text-right">Summa (USD)</th>
                      <th class="text-right">Asl summa</th>
                      <th class="text-center">Usul</th>
                      <th>Hisob nomi</th>
                      <th class="text-center" style="width: 50px;">FT</th>
                      <th>Izoh</th>
                      <th class="text-center">Sana</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr *ngFor="let entry of v2Entries; let i = index">
                      <td class="text-center">
                        <small>{{v2CurrentPage * v2PageSize + i + 1}}</small>
                      </td>
                      <td class="text-center">
                        <span class="type-badge" [ngClass]="getTypeBadgeClass(entry.type)">
                          {{getTypeLabel(entry.type)}}
                        </span>
                      </td>
                      <td>
                        <strong class="text-primary">K{{entry.customer_id}}</strong>
                        <span *ngIf="entry.customer">
                          <br>
                          <small class="text-muted">{{entry.customer.username}}</small>
                        </span>
                      </td>
                      <td>
                        <span *ngIf="entry.consignment" class="badge badge-info"
                          style="font-size: 12px; padding: 4px 8px;">
                          {{entry.consignment}}
                        </span>
                        <span *ngIf="!entry.consignment" class="text-muted">-</span>
                      </td>
                      <td class="text-right">
                        <strong [ngStyle]="{'color': entry.amount_usd > 0 ? '#f44336' : '#4caf50'}">
                          {{entry.amount_usd > 0 ? '+' : ''}}{{entry.amount_usd | number:'1.2-2'}}$
                        </strong>
                      </td>
                      <td class="text-right">
                        <span *ngIf="entry.amount_original">
                          {{formatCurrency(entry.amount_original)}}
                          <small class="text-muted">{{entry.currency}}</small>
                        </span>
                        <span *ngIf="!entry.amount_original" class="text-muted">-</span>
                      </td>
                      <td class="text-center">
                        <span *ngIf="entry.method" class="method-label">
                          {{getMethodLabel(entry.method)}}
                        </span>
                        <span *ngIf="!entry.method" class="text-muted">-</span>
                      </td>
                      <td>
                        <small *ngIf="entry.cash_account_name">{{entry.cash_account_name}}</small>
                        <span *ngIf="!entry.cash_account_name" class="text-muted">-</span>
                      </td>
                      <td class="text-center">
                        <i *ngIf="entry.fintrack_synced === true" class="material-icons"
                          style="font-size: 18px; color: #4caf50;" title="FinTrack bilan sinxronlangan">check_circle</i>
                        <i *ngIf="entry.fintrack_synced === false" class="material-icons"
                          style="font-size: 18px; color: #ff9800;" title="Sinxronlanmagan">sync_problem</i>
                        <span
                          *ngIf="entry.fintrack_synced === null || entry.fintrack_synced === undefined"
                          class="text-muted">-</span>
                      </td>
                      <td>
                        <div *ngIf="entry.comment; else noComment" class="comment-wrapper">
                          <small class="comment-short" *ngIf="!entry._expanded"
                            (click)="entry._expanded = true">
                            {{entry.comment.length > 30 ? entry.comment.substring(0, 30) + '...' : entry.comment}}
                            <i *ngIf="entry.comment.length > 30" class="material-icons comment-expand-icon">expand_more</i>
                          </small>
                          <small class="comment-full" *ngIf="entry._expanded"
                            (click)="entry._expanded = false">
                            {{entry.comment}}
                            <i class="material-icons comment-expand-icon">expand_less</i>
                          </small>
                        </div>
                        <ng-template #noComment><span class="text-muted">-</span></ng-template>
                      </td>
                      <td class="text-center">
                        <small class="text-muted">{{entry.created_at | date: 'dd/MM/yyyy HH:mm'}}</small>
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>

              <!-- V2 Pagination -->
              <app-pagination *ngIf="v2NeedPagination" [currentPage]="v2CurrentPage" [totalPages]="v2TotalPages"
                (pageChanged)="onV2PageChanged($event)"></app-pagination>

              <!-- V2 Empty -->
              <div *ngIf="!v2Loading && v2Entries.length === 0" class="text-center" style="padding: 60px 20px;">
                <i class="material-icons" style="font-size: 80px; color: #ccc;">receipt_long</i>
                <h5 class="mt-3">Ledger yozuvlari topilmadi</h5>
                <p class="text-muted">Filterlarni o'zgartirib ko'ring</p>
                <button class="btn btn-warning btn-sm mt-2" (click)="clearV2Filters()">
                  <i class="material-icons" style="font-size: 16px;">clear</i> Filterlarni tozalash
                </button>
              </div>
            </div>

            <!-- ═══════════════════════════════════════════ -->
            <!-- V1 TRANSACTIONS TAB -->
            <!-- ═══════════════════════════════════════════ -->
            <div *ngIf="activeTab === 'v1'">
              <div class="material-datatables">
                <!-- V1 Filters -->
                <div class="row" style="margin-bottom: 15px;">
                  <div class="col-sm-3 col-lg-3">
                    <mat-form-field class="example-full-width">
                      <input matInput type="text" style="font-size: large;" placeholder="Mijoz IDsi bo'yicha..."
                        (input)="getListOfTransactionsWithFilter($event.target.value,'')">
                    </mat-form-field>
                  </div>
                  <div class="col-sm-3 col-lg-3">
                    <mat-form-field class="example-full-width">
                      <input matInput type="text" style="font-size: large;" placeholder="Partiya bo'yicha"
                        (input)="getListOfTransactionsWithFilter('',$event.target.value)">
                    </mat-form-field>
                  </div>
                  <div class="col-sm-3 col-lg-2">
                    <mat-form-field>
                      <input matInput [matDatepicker]="danPicker" placeholder="...dan" (click)="danPicker.open()"
                        (dateChange)="danFunction($event)">
                      <mat-datepicker-toggle matSuffix [for]="danPicker"></mat-datepicker-toggle>
                      <mat-datepicker #danPicker></mat-datepicker>
                    </mat-form-field>
                  </div>
                  <div class="col-sm-3 col-lg-2">
                    <mat-form-field>
                      <input matInput [matDatepicker]="gachaPicker" placeholder="...gacha" (click)="gachaPicker.open()"
                        (dateChange)="gachaFunction($event)">
                      <mat-datepicker-toggle matSuffix [for]="gachaPicker"></mat-datepicker-toggle>
                      <mat-datepicker #gachaPicker></mat-datepicker>
                    </mat-form-field>
                  </div>
                  <div class="col-sm-3 col-lg-2">
                    <button mat-raised-button (click)="getListOfTransactionsWithDate()"
                      class="btn btn-success btn-round btn-block">Xisob Kitob</button>
                  </div>
                </div>

                <!-- V1 Loading -->
                <div *ngIf="v1Loading" class="text-center" style="padding: 40px 20px;">
                  <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;"></div>
                  <p class="mt-3 text-muted">Ma'lumotlar yuklanmoqda...</p>
                </div>

                <!-- V1 Table -->
                <div *ngIf="!v1Loading" class="table-responsive">
                  <table class="table table-striped table-no-bordered table-hover" cellspacing="0" width="100%"
                    style="width:100%">
                    <thead>
                      <tr>
                        <th class="text-center">No</th>
                        <th class="text-center">Partiya</th>
                        <th class="text-center">Mijoz IDsi</th>
                        <th class="text-center">Naqd</th>
                        <th class="text-center">Karta</th>
                        <th class="text-center">USD</th>
                        <th class="text-center">BankAcc</th>
                        <th class="text-center">Qarz(Nasiya)</th>
                        <th class="text-center">Izoh</th>
                        <th class="text-center">Sana</th>
                        <th class="text-center">Amallar</th>
                      </tr>
                    </thead>
                    <tbody>
                      <tr *ngFor="let row of allTransactions; let i = index" class="text-center">
                        <td>{{ (currentPage * pageSize) + i + 1 }}</td>
                        <td>{{row.consignment}}</td>
                        <td>{{row.owner_id}}</td>
                        <td>{{row.cash}}</td>
                        <td>{{row.plastic}}</td>
                        <td>{{row.usd}} <i *ngIf="row.usd">$</i></td>
                        <td>{{row.bank_account}}</td>
                        <td>{{row.for_debt}}</td>
                        <td>{{row.comment}}</td>
                        <td>{{row.registered_date | date: 'dd/MM/yyyy'}}</td>
                        <td>
                          <a (click)="editTransaction(row.id)"
                            class="btn btn-link btn-success btn-just-icon">
                            <i class="material-icons">edit</i>
                          </a>
                        </td>
                      </tr>
                    </tbody>
                  </table>
                </div>

                <!-- V1 Pagination -->
                <app-pagination *ngIf="needPagination" [currentPage]="currentPage" [totalPages]="totalPages"
                  (pageChanged)="onPageChanged($event)"></app-pagination>
              </div>
            </div>

          </div>
        </div>
      </div>
    </div>
  </div>
</div>
