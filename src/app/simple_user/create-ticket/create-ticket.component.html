<div class="main-content">
    <div class="container-fluid">



        <!-- Main Form Card -->
        <div class="row">
            <div class="col-md-12">
                <div class="card submit-ticket-card">
                    <div class="card-body">

                        <form class="ticket-form">

                            <!-- Related Service -->
                            <div class="form-group">
                                <label class="form-label">{{ isChinaStaff ? 'Related Service' : 'Tegishli Xizmat' }}</label>
                                <select class="form-control" [(ngModel)]="relatedService" name="relatedService"
                                    [disabled]="isSubmitting">
                                    <option *ngFor="let service of serviceOptions" [value]="service.value">
                                        {{ service.label }}
                                    </option>
                                </select>
                            </div>

                            <!-- Assign to Role -->
                            <div class="form-group">
                                <label class="form-label">{{ isChinaStaff ? 'Assign to' : 'Kimga yo\'naltirish' }}</label>
                                <select class="form-control" [(ngModel)]="selectedRole" name="selectedRole"
                                    [disabled]="isSubmitting">
                                    <option *ngFor="let role of roleOptions" [value]="role.value">
                                        {{ role.label }}
                                    </option>
                                </select>
                                <small class="form-text text-muted" *ngIf="isChinaStaff">
                                    Choose which staff to assign your ticket to. If "Auto Assign", the system will choose based on category.
                                </small>
                                <small class="form-text text-muted" *ngIf="!isChinaStaff">
                                    Murojaatingizni qaysi xodimga yo'naltirishni tanlang. "Avtomatik tanlash" bo'lsa, tizim kategoriya asosida tanlaydi.
                                </small>
                            </div>

                            <!-- Message (Rich Text Editor Style) -->
                            <div class="form-group">
                                <label class="form-label required">{{ isChinaStaff ? 'Message*' : 'Xabar*' }}</label>

                                <!-- Editor Toolbar -->
                                <div class="rich-text-toolbar">
                                    <button type="button" class="toolbar-btn" [title]="isChinaStaff ? 'Bold (Ctrl+B)' : 'Qalin (Ctrl+B)'"
                                        (click)="formatBold()">
                                        <strong>B</strong>
                                    </button>
                                    <button type="button" class="toolbar-btn" [title]="isChinaStaff ? 'Italic (Ctrl+I)' : 'Qiyshiq (Ctrl+I)'"
                                        (click)="formatItalic()">
                                        <em>I</em>
                                    </button>
                                    <button type="button" class="toolbar-btn" [title]="isChinaStaff ? 'Heading' : 'Sarlavha'" (click)="formatHeading()">
                                        <strong>H</strong>
                                    </button>
                                    <button type="button" class="toolbar-btn" [title]="isChinaStaff ? 'Link' : 'Havola'" (click)="insertLink()">
                                        <mat-icon>link</mat-icon>
                                    </button>
                                    <button type="button" class="toolbar-btn" [title]="isChinaStaff ? 'Bullet list' : 'Nuqtali ro\'yxat'"
                                        (click)="insertBulletList()">
                                        <mat-icon>format_list_bulleted</mat-icon>
                                    </button>
                                    <button type="button" class="toolbar-btn" [title]="isChinaStaff ? 'Numbered list' : 'Raqamlangan ro\'yxat'"
                                        (click)="insertNumberedList()">
                                        <mat-icon>format_list_numbered</mat-icon>
                                    </button>
                                    <button type="button" class="toolbar-btn" [title]="isChinaStaff ? 'Quote' : 'Iqtibos'" (click)="insertQuote()">
                                        <mat-icon>format_quote</mat-icon>
                                    </button>
                                    <button type="button" class="toolbar-btn btn-preview" [title]="isChinaStaff ? 'Preview' : 'Ko\'rish'"
                                        (click)="showPreview()">
                                        <mat-icon>visibility</mat-icon> {{ isChinaStaff ? 'Preview' : 'Ko\'rish' }}
                                    </button>
                                    <button type="button" class="toolbar-btn" [title]="isChinaStaff ? 'Help' : 'Yordam'" (click)="showHelp()">
                                        <mat-icon>help</mat-icon>
                                    </button>
                                    <button type="button" class="toolbar-btn" [title]="isChinaStaff ? 'Fullscreen' : 'To\'liq ekran'"
                                        (click)="toggleFullscreen()">
                                        <mat-icon>fullscreen</mat-icon>
                                    </button>
                                </div>

                                <!-- Textarea -->
                                <textarea #messageTextarea class="form-control message-textarea" [(ngModel)]="message"
                                    name="message" (ngModelChange)="onMessageChange()" rows="12"
                                    [disabled]="isSubmitting" [placeholder]="isChinaStaff ? 'Describe the issue in detail...' : 'Muammoni batafsil tavsiflang...'"
                                    autofocus></textarea>

                                <!-- Editor Footer Stats -->
                                <div class="editor-footer">
                                    <span class="editor-stats">
                                        {{ isChinaStaff ? 'lines' : 'qatorlar' }}: <strong>{{ getLineCount() }}</strong>
                                        {{ isChinaStaff ? 'words' : 'so\'zlar' }}: <strong>{{ getWordCount() }}</strong>
                                        <span class="save-status">{{ isChinaStaff ? 'saved' : 'saqlandi' }}</span>
                                    </span>
                                </div>
                            </div>

                            <!-- Attachments -->
                            <div class="form-group">
                                <label class="form-label">{{ isChinaStaff ? 'Attachments' : 'Ilovalar' }}</label>

                                <!-- Hidden file input -->
                                <input type="file" id="fileInput" multiple [accept]="allowedExtensions.join(',')"
                                    (change)="onFileSelected($event)" style="display: none;">

                                <div class="file-upload-area">
                                    <!-- File Preview Area -->
                                    <div class="file-upload-placeholder" *ngIf="selectedFiles.length > 0">
                                        <div class="file-preview-list">
                                            <div *ngFor="let file of selectedFiles; let i = index"
                                                class="file-preview-item">
                                                <!-- Image Preview -->
                                                <div *ngIf="isImage(file)" class="file-image-preview">
                                                    <img [src]="getImagePreview(file)" alt="Preview">
                                                    <button type="button" class="btn-remove-file"
                                                        (click)="removeFile(i)" [title]="isChinaStaff ? 'Remove file' : 'Faylni o\'chirish'">
                                                        <mat-icon>close</mat-icon>
                                                    </button>
                                                </div>

                                                <!-- Non-Image File Preview -->
                                                <div *ngIf="!isImage(file)" class="file-doc-preview">
                                                    <mat-icon class="file-icon">{{ getFileIcon(file.name) }}</mat-icon>
                                                    <div class="file-details">
                                                        <span class="file-name">{{ file.name }}</span>
                                                        <span class="file-size">{{ getFileSize(file.size) }}</span>
                                                    </div>
                                                    <button type="button" class="btn-remove-file"
                                                        (click)="removeFile(i)" [title]="isChinaStaff ? 'Remove file' : 'Faylni o\'chirish'">
                                                        <mat-icon>close</mat-icon>
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="file-upload-buttons">
                                        <button type="button" class="btn-choose-file" (click)="onChooseFile()"
                                            [disabled]="isSubmitting || selectedFiles.length >= maxFiles">
                                            <mat-icon>folder</mat-icon>
                                            <ng-container *ngIf="isChinaStaff">
                                                {{ selectedFiles.length === 0 ? 'Choose file' : 'Add more files' }}
                                            </ng-container>
                                            <ng-container *ngIf="!isChinaStaff">
                                                {{ selectedFiles.length === 0 ? 'Fayl tanlash' : 'Yana fayl qo\'shish' }}
                                            </ng-container>
                                        </button>
                                        <span class="file-count" *ngIf="selectedFiles.length > 0">
                                            <ng-container *ngIf="isChinaStaff">
                                                {{ selectedFiles.length }} / {{ maxFiles }} files selected
                                            </ng-container>
                                            <ng-container *ngIf="!isChinaStaff">
                                                {{ selectedFiles.length }} / {{ maxFiles }} ta fayl tanlandi
                                            </ng-container>
                                        </span>
                                    </div>

                                    <small class="file-extensions-note" *ngIf="isChinaStaff">
                                        Allowed file types: .jpg, .gif, .jpeg, .png, .zip, .rar, .pdf (Max 5MB each)
                                    </small>
                                    <small class="file-extensions-note" *ngIf="!isChinaStaff">
                                        Ruxsat etilgan fayl turlari: .jpg, .gif, .jpeg, .png, .zip, .rar, .pdf (Har bir fayl maks 5MB)
                                    </small>
                                </div>
                            </div>

                            <!-- Form Actions -->
                            <div class="form-actions">
                                <button mat-raised-button color="primary" type="button" (click)="onSubmit()"
                                    [disabled]="!isFormValid() || isSubmitting" class="btn-submit">
                                    <ng-container *ngIf="isChinaStaff">
                                        {{ isSubmitting ? 'Submitting...' : 'Submit' }}
                                    </ng-container>
                                    <ng-container *ngIf="!isChinaStaff">
                                        {{ isSubmitting ? 'Yuborilmoqda...' : 'Yuborish' }}
                                    </ng-container>
                                </button>
                                <button mat-raised-button type="button" (click)="onCancel()" [disabled]="isSubmitting"
                                    class="btn-cancel">
                                    {{ isChinaStaff ? 'Cancel' : 'Bekor qilish' }}
                                </button>
                            </div>

                        </form>

                    </div>
                </div>
            </div>
        </div>

    </div>
</div>
