<div class="ticket-detail-container">
    <div class="container-fluid">
        <div class="row">
            <div class="col-md-12">

                <!-- Loading State -->
                <div *ngIf="isLoading" class="text-center py-5">
                    <mat-spinner class="mx-auto"></mat-spinner>
                    <p class="mt-3">Loading ticket details...</p>
                </div>

                <!-- Ticket Detail Content -->
                <div *ngIf="!isLoading && ticket">

                    <!-- Back Button & Ticket Header -->
                    <div class="card mt-5">

                        <div class="card-body">
                            <button mat-raised-button (click)="goBack()" class="mr-2">
                                <mat-icon>arrow_back</mat-icon>
                                Back to Tickets
                            </button>
                        </div>
                    </div>



                    <!-- Messages Card with Telegram Style -->
                    <div class="card">
                        <div class="card-header card-header-success">
                            <h5 class="card-title mb-0">
                                <mat-icon class="align-middle">chat</mat-icon>
                                Conversation
                            </h5>
                        </div>
                        <div class="card-body p-0">

                            <!-- MESSAGE THREAD (Telegram Style - copied from message-thread component) -->
                            <div class="message-thread-container" #messagesContainer>

                                <!-- Empty State -->
                                <div *ngIf="displayMessages.length === 0" class="empty-state">
                                    <mat-icon>chat_bubble_outline</mat-icon>
                                    <p>No messages yet</p>
                                </div>

                                <!-- Message List -->
                                <div class="messages-list" *ngIf="displayMessages.length > 0">
                                    <div *ngFor="let message of displayMessages" class="message-wrapper" [ngClass]="{
                                           'message-customer': isCustomerMessage(message),
                                           'message-staff': isStaffMessage(message)
                                         }">

                                        <div class="message-bubble">
                                            <!-- Message Header -->
                                            <div class="message-header">
                                                <div class="sender-info">
                                                    <div class="sender-avatar"
                                                        [ngClass]="isCustomerMessage(message) ? 'avatar-customer' : 'avatar-staff'">
                                                        {{ getInitials(message.sender_name) }}
                                                    </div>
                                                    <div class="sender-details">
                                                        <strong class="sender-name">{{ message.sender_name }}</strong>
                                                        <span class="message-time">{{ formatDate(message.created_at)
                                                            }}</span>
                                                    </div>
                                                </div>
                                                <span class="badge"
                                                    [ngClass]="isCustomerMessage(message) ? 'badge-info' : 'badge-purple'">
                                                    {{ isCustomerMessage(message) ? 'Customer' : 'Staff' }}
                                                </span>
                                            </div>

                                            <!-- Message Content -->
                                            <div class="message-content"
                                                [innerHTML]="renderMessageHTML(message.message_text)"></div>

                                            <!-- Attachments - Telegram Style -->
                                            <div class="message-attachments" *ngIf="hasAttachments(message)">
                                                <div class="attachment-grid">
                                                    <div *ngFor="let attachment of message.attachments"
                                                        class="attachment-item">

                                                        <!-- Image Preview (Telegram Style) -->
                                                        <div *ngIf="isImageFile(attachment.file_name)"
                                                            class="attachment-image"
                                                            (click)="openImagePreview(attachment.file_url)">
                                                            <img [src]="attachment.file_url"
                                                                [alt]="attachment.file_name" class="message-image">
                                                            <div class="image-overlay">
                                                                <mat-icon>zoom_in</mat-icon>
                                                            </div>
                                                            <div class="image-info">
                                                                <span class="image-filename">{{ attachment.file_name
                                                                    }}</span>
                                                                <span class="image-size">{{
                                                                    formatFileSize(attachment.file_size) }}</span>
                                                            </div>
                                                        </div>

                                                        <!-- PDF File Card -->
                                                        <div *ngIf="isPdfFile(attachment.file_name)"
                                                            class="attachment-doc pdf-doc">
                                                            <div class="doc-icon">
                                                                <mat-icon>picture_as_pdf</mat-icon>
                                                            </div>
                                                            <div class="doc-details">
                                                                <span class="doc-name">{{ attachment.file_name }}</span>
                                                                <span class="doc-size">{{
                                                                    formatFileSize(attachment.file_size) }}</span>
                                                            </div>
                                                            <a [href]="attachment.file_url" target="_blank"
                                                                class="doc-action">
                                                                <mat-icon>open_in_new</mat-icon>
                                                            </a>
                                                        </div>

                                                        <!-- Other Files Card -->
                                                        <div *ngIf="!isImageFile(attachment.file_name) && !isPdfFile(attachment.file_name)"
                                                            class="attachment-doc">
                                                            <div class="doc-icon">
                                                                <mat-icon>{{ getAttachmentIcon(attachment.file_name)
                                                                    }}</mat-icon>
                                                            </div>
                                                            <div class="doc-details">
                                                                <span class="doc-name">{{ attachment.file_name }}</span>
                                                                <span class="doc-size">{{
                                                                    formatFileSize(attachment.file_size) }}</span>
                                                            </div>
                                                            <a [href]="attachment.file_url" download class="doc-action">
                                                                <mat-icon>download</mat-icon>
                                                            </a>
                                                        </div>

                                                    </div>
                                                </div>
                                            </div>
                                        </div>

                                    </div>
                                </div>

                            </div>
                            <!-- END MESSAGE THREAD -->

                        </div>
                    </div>

                    <!-- Reply Form Card (Telegram Style - copied from reply-box component) -->
                    <div class="card" *ngIf="!isTicketClosed()">
                        <div class="card-header card-header-success">
                            <h5 class="card-title mb-0">
                                <mat-icon class="align-middle">reply</mat-icon>
                                Adminga Javob Qaytarish
                            </h5>
                        </div>
                        <div class="card-body">

                            <!-- REPLY BOX (copied from reply-box component) -->
                            <div class="reply-box-container">

                                <!-- File Preview Section -->
                                <div class="file-preview-section" *ngIf="selectedFiles.length > 0">
                                    <div class="file-preview-header">
                                        <span class="file-count">{{ selectedFiles.length }} file(s) selected</span>
                                        <button mat-icon-button (click)="clearAllFiles()" matTooltip="Remove all files">
                                            <mat-icon>close</mat-icon>
                                        </button>
                                    </div>
                                    <div class="file-preview-list">
                                        <div *ngFor="let file of selectedFiles; let i = index"
                                            class="file-preview-item">
                                            <!-- Image Preview -->
                                            <div *ngIf="isImageFile(file.name)" class="preview-image">
                                                <img [src]="file.preview" [alt]="file.name">
                                            </div>
                                            <!-- File Icon -->
                                            <div *ngIf="!isImageFile(file.name)" class="preview-icon">
                                                <mat-icon>{{ getFileIcon(file.name) }}</mat-icon>
                                            </div>
                                            <!-- File Info -->
                                            <div class="preview-info">
                                                <span class="preview-name">{{ file.name }}</span>
                                                <span class="preview-size">{{ formatFileSize(file.size) }}</span>
                                            </div>
                                            <!-- Remove Button -->
                                            <button mat-icon-button (click)="removeFile(i)" class="preview-remove">
                                                <mat-icon>close</mat-icon>
                                            </button>
                                        </div>
                                    </div>
                                </div>

                                <!-- Message Input Section -->
                                <!-- Message Input Section (Telegram Style) -->
                                <div class="message-input-section telegram-style">

                                    <!-- File Upload Button (LEFT) -->
                                    <button mat-icon-button (click)="fileInput.click()"
                                        [disabled]="selectedFiles.length >= maxFiles" matTooltip="Attach files"
                                        class="attach-button">
                                        <mat-icon>attach_file</mat-icon>
                                    </button>
                                    <input type="file" #fileInput (change)="onFileSelect($event)" multiple
                                        accept="image/*,.pdf,.zip,.rar" style="display: none;">

                                    <!-- Textarea (CENTER - grows) -->
                                    <textarea [(ngModel)]="messageText" placeholder="Type your message here..."
                                        class="message-textarea telegram-textarea" rows="1" [disabled]="isSubmitting"
                                        (keydown)="onKeyDown($event)">
                                </textarea>

                                    <!-- Character Count (RIGHT) -->
                                    <span class="char-count" [ngClass]="{'text-warning': messageText.length > 900}">
                                        {{ messageText.length }}
                                    </span>

                                    <!-- Submit Button (FAR RIGHT) -->
                                    <button mat-icon-button color="primary" (click)="onSubmitReply()"
                                        [disabled]="!isValid() || isSubmitting" class="send-button">
                                        <mat-spinner *ngIf="isSubmitting" diameter="20"></mat-spinner>
                                        <mat-icon *ngIf="!isSubmitting">send</mat-icon>
                                    </button>

                                </div>

                            </div>
                            <!-- END REPLY BOX -->

                        </div>
                    </div>

                    <!-- Closed Ticket Notice -->
                    <div class="alert alert-secondary" *ngIf="isTicketClosed()">
                        <mat-icon class="align-middle">lock</mat-icon>
                        This ticket has been closed. If you need further assistance, please create a new ticket.
                        <button mat-raised-button color="primary" class="ml-3" [routerLink]="['/create-ticket']">
                            <mat-icon>add</mat-icon>
                            New Ticket
                        </button>
                    </div>
                    <div class="card-header card-header-primary">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h4 class="card-title mb-0">
                                    <mat-icon class="align-middle">confirmation_number</mat-icon>
                                    Ticket #{{ ticket.ticket_number }}
                                </h4>
                            </div>
                            <div>
                                <span class="badge" [ngClass]="getStatusClass(ticket.status)">
                                    {{ getStatusLabel(ticket.status) }}
                                </span>
                                <span class="badge ml-2" [ngClass]="getPriorityClass(ticket.priority)">
                                    {{ getPriorityLabel(ticket.priority) }}
                                </span>
                            </div>
                        </div>
                    </div>

                    <!-- Ticket Details Accordion -->
                    <div class="card">
                        <div class="card-header card-header-info" style="cursor: pointer;" (click)="toggleTicketInfo()">
                            <h5 class="card-title mb-0">
                                <mat-icon class="align-middle">
                                    {{ isTicketInfoExpanded ? 'expand_less' : 'expand_more' }}
                                </mat-icon>
                                Ticket Details
                            </h5>
                        </div>
                        <div class="card-body" *ngIf="isTicketInfoExpanded">
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <h6>Status</h6>
                                    <p>
                                        <span class="badge" [ngClass]="getStatusClass(ticket.status)">
                                            {{ getStatusLabel(ticket.status) }}
                                        </span>
                                    </p>
                                    <small class="text-muted">{{ getStatusExplanation(ticket.status) }}</small>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <h6>Priority</h6>
                                    <p>
                                        <span class="badge" [ngClass]="getPriorityClass(ticket.priority)">
                                            {{ getPriorityLabel(ticket.priority) }}
                                        </span>
                                    </p>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <h6>Created</h6>
                                    <p>{{ formatDate(ticket.created_at) }}</p>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <h6>Last Updated</h6>
                                    <p>{{ formatDate(ticket.updated_at) }}</p>
                                </div>
                                <div class="col-md-6 mb-3" *ngIf="ticket.assigned_to">
                                    <h6>Assigned To</h6>
                                    <p>{{ ticket.assigned_to }}</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Subject Card -->
                    <div class="card">
                        <div class="card-header card-header-info">
                            <h5 class="card-title mb-0">
                                <mat-icon class="align-middle">subject</mat-icon>
                                Mavzusi
                            </h5>
                        </div>
                        <div class="card-body">
                            <h5>{{ ticket.subject }}</h5>
                            <p class="text-muted mb-0">
                                <mat-icon class="icon-xs">folder</mat-icon>
                                Kategoriyasi: {{ getCategoryLabel(ticket.category) }}
                            </p>
                        </div>
                    </div>

                    <!-- Help Section -->
                    <!-- <div class="card">
                        <div class="card-header card-header-warning" style="cursor: pointer;"
                            (click)="toggleHelpSection()">
                            <h5 class="card-title mb-0">
                                <mat-icon class="align-middle">
                                    {{ isHelpSectionExpanded ? 'expand_less' : 'expand_more' }}
                                </mat-icon>
                                Need Help?
                            </h5>
                        </div>
                        <div class="card-body" *ngIf="isHelpSectionExpanded">
                            <h6>How to get faster support:</h6>
                            <ul>
                                <li>Provide as much detail as possible in your messages</li>
                                <li>Attach screenshots or photos if relevant</li>
                                <li>Include tracking numbers or order IDs when applicable</li>
                                <li>Reply promptly to questions from support staff</li>
                            </ul>
                            <h6 class="mt-3">Response Times:</h6>
                            <p class="mb-0">
                                <mat-icon class="icon-xs">schedule</mat-icon>
                                We aim to respond to all tickets within 24 hours during business days.
                            </p>
                        </div>
                    </div> -->


                </div>

            </div>
        </div>
    </div>
</div>

<!-- Image Preview Modal (from message-thread component) -->
<div class="image-modal" *ngIf="selectedImage" (click)="closeImagePreview()">
    <div class="image-modal-content" (click)="$event.stopPropagation()">
        <button class="image-modal-close" (click)="closeImagePreview()">
            <mat-icon>close</mat-icon>
        </button>
        <img [src]="selectedImage" alt="Preview">
    </div>
</div>